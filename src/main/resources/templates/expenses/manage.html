<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" th:replace="~{layout :: layout(~{::section})}">
<section th:fragment="content">
    <div class="card">
        <div class="table-actions">
            <div>
                <button type="button" class="button" data-open-modal="expenseModal" data-mode="create">
                    + Thêm chi phí
                </button>
            </div>
            <div class="pagination" th:if="${totalPages > 1}">
                <a class="page-link"
                   th:classappend="${currentPage == 0}? 'disabled'"
                   th:href="${currentPage == 0}? '#': @{/cms/expenses(page=${currentPage - 1}, size=${pageSize})}">Trang trước</a>
                <a class="page-link"
                   th:each="pageNum : ${#numbers.sequence(0, totalPages - 1)}"
                   th:text="${pageNum + 1}"
                   th:href="@{/cms/expenses(page=${pageNum}, size=${pageSize})}"
                   th:classappend="${pageNum == currentPage}? 'active'">1</a>
                <a class="page-link"
                   th:classappend="${currentPage + 1 >= totalPages}? 'disabled'"
                   th:href="${currentPage + 1 >= totalPages}? '#': @{/cms/expenses(page=${currentPage + 1}, size=${pageSize})}">Trang sau</a>
            </div>
        </div>
        <div class="table-wrapper">
            <table class="data-table">
                <thead>
                <tr>
                    <th>Nhân viên</th>
                    <th>Dự án</th>
                    <th>Danh mục</th>
                    <th>Số tiền</th>
                    <th>Ngày</th>
                    <th>Trạng thái</th>
                    <th></th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="expense : ${expenses}">
                    <td th:text="${#lists.find(employees, e -> e.id == expense.employeeId)?.fullName}">Nhân viên</td>
                    <td th:text="${#lists.find(projects, p -> p.id == expense.projectId)?.name}">Dự án</td>
                    <td th:text="${expense.category}">Category</td>
                    <td th:text="${#numbers.formatDecimal(expense.amount, 1, 'DEFAULT', 2, 'DEFAULT')}">0</td>
                    <td th:text="${expense.incurredDate}">2024-01-01</td>
                    <td th:text="${expense.status}">SUBMITTED</td>
                    <td class="actions-cell">
                        <button type="button" class="button-link" data-open-modal="expenseModal" data-mode="edit"
                                th:attr="data-record-id=${expense.id},
                                         data-value-employee-id=${expense.employeeId},
                                         data-value-project-id=${expense.projectId},
                                         data-value-category=${expense.category},
                                         data-value-amount=${expense.amount},
                                         data-value-incurred-date=${expense.incurredDate},
                                         data-value-description=${expense.description}">
                            Chỉnh sửa
                        </button>
                        <button type="button" class="button-link" data-open-modal="expenseStatusModal" data-mode="edit"
                                th:attr="data-record-id=${expense.id},
                                         data-value-status=${expense.status},
                                         data-value-expense-name=${expense.category}">
                            Cập nhật trạng thái
                        </button>
                        <form th:action="@{/cms/expenses/{id}/delete(id=${expense.id})}" method="post"
                              th:attr="data-confirm-message=${'Bạn có muốn xóa chi phí ' + expense.category + '?'}">
                            <button type="submit" class="link danger">Xóa</button>
                        </form>
                    </td>
                </tr>
                <tr th:if="${expenses.isEmpty()}">
                    <td colspan="7" class="empty">Chưa có chi phí nào</td>
                </tr>
                </tbody>
            </table>
        </div>
        <div class="table-summary" th:if="${totalElements > 0}">
            <span th:text="${'Đang hiển thị ' + (currentPage * pageSize + 1) + ' - ' + T(java.lang.Math).min((currentPage + 1) * pageSize, totalElements) + ' / ' + totalElements + ' Chi phí'}">Tổng quan</span>
        </div>
    </div>

    <div class="modal-backdrop"
         id="expenseModal"
         data-modal
         th:data-open="${showExpenseModal} ? 'true' : 'false'"
         th:data-mode="${expenseModalMode}"
         th:data-record-id="${expenseEditId}"
         th:data-create-url="@{/cms/expenses}"
         th:data-update-template="@{/cms/expenses/__ID__/update}"
         data-create-title="Thêm chi phí"
         data-edit-title="Cập nhật chi phí"
         data-create-text="Lưu"
         data-edit-text="Cập nhật">
        <div class="modal">
            <div class="modal-header">
                <h2 data-modal-title>Quản lý chi phí</h2>
                <button type="button" class="icon-button" data-close-modal>&times;</button>
            </div>
            <form id="expenseForm" th:action="@{/cms/expenses}" th:object="${expenseForm}" method="post">
                <div class="modal-body grid two-columns">
                    <div class="field">
                        <label for="expenseEmployee">Nhân viên</label>
                        <select id="expenseEmployee" th:field="*{employeeId}" data-field="employeeId">
                            <option value="">-- Chọn nhân viên --</option>
                            <option th:each="employee : ${employees}"
                                    th:value="${employee.id}"
                                    th:text="${employee.fullName}">Nhân viên</option>
                        </select>
                        <small th:if="${#fields.hasErrors('employeeId')}" th:errors="*{employeeId}" class="error-text">Lỗi</small>
                    </div>
                    <div class="field">
                        <label for="expenseProject">Dự án</label>
                        <select id="expenseProject" th:field="*{projectId}" data-field="projectId">
                            <option value="">-- Không liên kết --</option>
                            <option th:each="project : ${projects}"
                                    th:value="${project.id}"
                                    th:text="${project.name}">Dự án</option>
                        </select>
                    </div>
                    <div class="field">
                        <label for="category">Danh mục</label>
                        <input id="category" th:field="*{category}" data-field="category" type="text" placeholder="Cong tac">
                        <small th:if="${#fields.hasErrors('category')}" th:errors="*{category}" class="error-text">Lỗi</small>
                    </div>
                    <div class="field">
                        <label for="amount">Số tiền</label>
                        <input id="amount" th:field="*{amount}" data-field="amount" type="number" step="0.01">
                        <small th:if="${#fields.hasErrors('amount')}" th:errors="*{amount}" class="error-text">Lỗi</small>
                    </div>
                    <div class="field">
                        <label for="incurredDate">Ngày phát sinh</label>
                        <input id="incurredDate" th:field="*{incurredDate}" data-field="incurredDate" type="date">
                        <small th:if="${#fields.hasErrors('incurredDate')}" th:errors="*{incurredDate}" class="error-text">Lỗi</small>
                    </div>
                    <div class="field">
                        <label for="description">Mô tả</label>
                        <textarea id="description" th:field="*{description}" data-field="description" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="button secondary" data-close-modal>Hủy</button>
                    <button type="submit" class="button" data-modal-submit>Lưu</button>
                </div>
            </form>
        </div>
    </div>

    <div class="modal-backdrop"
         id="expenseStatusModal"
         data-modal
         th:data-open="${showStatusModal} ? 'true' : 'false'"
         th:data-mode="'edit'"
         th:data-record-id="${statusExpenseId}"
         th:data-update-template="@{/cms/expenses/__ID__/status}"
         data-edit-title="Cập nhật trạng thái"
         data-edit-text="Cập nhật">
        <div class="modal">
            <div class="modal-header">
                <h2 data-modal-title>Cập nhật trạng thái</h2>
                <button type="button" class="icon-button" data-close-modal>&times;</button>
            </div>
            <form id="statusForm" th:action="@{/cms/expenses}" th:object="${statusForm}" method="post">
                <div class="modal-body">
                    <div class="field">
                        <label for="statusSelect">Trạng thái</label>
                        <select id="statusSelect" th:field="*{status}" data-field="status">
                            <option value="">-- Chọn trạng thái --</option>
                            <option th:each="status : ${expenseStatuses}"
                                    th:value="${status}"
                                    th:text="${status}">STATUS</option>
                        </select>
                        <small th:if="${#fields.hasErrors('status')}" th:errors="*{status}" class="error-text">Lỗi</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="button secondary" data-close-modal>Hủy</button>
                    <button type="submit" class="button" data-modal-submit>Cập nhật</button>
                </div>
            </form>
        </div>
    </div>
</section>
</html>




