<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" th:replace="~{layout :: layout(~{::section})}">
<section th:fragment="content">
    <div class="card">
        <div class="table-actions">
            <div>
                <button type="button" class="button" data-open-modal="projectModal" data-mode="create">
                    + Thêm dự án
                </button>
            </div>
            <div class="pagination" th:if="${totalPages > 1}">
                <a class="page-link"
                   th:classappend="${currentPage == 0}? 'disabled'"
                   th:href="${currentPage == 0}? '#': @{/cms/projects(page=${currentPage - 1}, size=${pageSize})}">Trang trước</a>
                <a class="page-link"
                   th:each="pageNum : ${#numbers.sequence(0, totalPages - 1)}"
                   th:text="${pageNum + 1}"
                   th:href="@{/cms/projects(page=${pageNum}, size=${pageSize})}"
                   th:classappend="${pageNum == currentPage}? 'active'">1</a>
                <a class="page-link"
                   th:classappend="${currentPage + 1 >= totalPages}? 'disabled'"
                   th:href="${currentPage + 1 >= totalPages}? '#': @{/cms/projects(page=${currentPage + 1}, size=${pageSize})}">Trang sau</a>
            </div>
        </div>
        <div class="table-wrapper">
            <table class="data-table">
                <thead>
                <tr>
                    <th>Mã</th>
                    <th>Tên dự án</th>
                    <th>Trạng thái</th>
                    <th>Thời gian</th>
                    <th>Quản lý</th>
                    <th></th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="project : ${projects}">
                    <td th:text="${project.code}">PRJ-001</td>
                    <td th:text="${project.name}">Dự án</td>
                    <td th:text="${project.status}">ACTIVE</td>
                    <td>
                        <span th:text="${project.startDate}">2024-01-01</span>
                        <span> - </span>
                        <span th:text="${project.endDate}">2024-03-31</span>
                    </td>
                    <td th:text="${project.managerId != null ? managerNames[project.managerId] : '—'}">Quản lý</td>
                    <td class="actions-cell">
                        <button type="button" class="button-link" data-open-modal="projectModal" data-mode="edit"
                                th:attr="data-record-id=${project.id},
                                         data-update-url=@{/cms/projects/{id}/update(id=${project.id})},
                                         data-value-code=${project.code},
                                         data-value-name=${project.name},
                                         data-value-description=${project.description},
                                         data-value-start-date=${project.startDate},
                                         data-value-end-date=${project.endDate},
                                         data-value-status=${project.status},
                                         data-value-manager-id=${project.managerId}">
                            Chỉnh sửa
                        </button>
                        <button type="button" class="button-link" data-open-modal="assignmentModal" data-mode="create"
                                th:attr="data-value-project-id=${project.id},
                                         data-value-project-name=${project.name}">
                            Gán nhân sự
                        </button>
                        <form th:action="@{/cms/projects/{id}/delete(id=${project.id})}" method="post"
                              th:attr="data-confirm-message=${'Bạn có muốn xóa dự án ' + project.name + '?'}">
                            <button type="submit" class="link danger">Xóa</button>
                        </form>
                    </td>
                </tr>
                <tr th:if="${projects.isEmpty()}">
                    <td colspan="6" class="empty">Chưa có dự án nào</td>
                </tr>
                </tbody>
            </table>
        </div>
        <div class="table-summary" th:if="${totalElements > 0}">
            <p th:text="'Đang hiển thị ' + ${startRecord} + ' - ' + ${endRecord} + ' / ' + ${totalElements} + ' bản ghi'"></p>
        </div>
    </div>

    <div class="card assignment-list" th:if="${!projects.isEmpty()}">
        <h2>Phân công</h2>
        <div th:each="project : ${projects}" class="assignment-group">
            <h3 th:text="${project.name}">Project</h3>
            <table class="data-table condensed">
                <thead>
                <tr>
                    <th>Nhân viên</th>
                    <th>Vai trò</th>
                    <th>Tỷ lệ</th>
                    <th>Thời gian</th>
                    <th></th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="assignment : ${assignmentMap[project.id]}">
                    <td th:text="${employeeNames[assignment.employeeId]} ?: '—'">Nhân viên</td>
                    <td th:text="${assignment.roleName}">Role</td>
                    <td th:text="${assignment.allocationPercent}">100</td>
                    <td>
                        <span th:text="${assignment.startDate}">2024-01-01</span>
                        <span> - </span>
                        <span th:text="${assignment.endDate}">2024-02-01</span>
                    </td>
                    <td class="actions-cell">
                        <form th:action="@{/cms/projects/assignments/{id}/delete(id=${assignment.id})}" method="post"
                              th:attr="data-confirm-message=${'Bạn có muốn xóa phân công của ' + (employeeNames[assignment.employeeId] ?: 'nhân viên này') + '?'}"
                            <button type="submit" class="link danger">Xóa</button>
                        </form>
                    </td>
                </tr>
                <tr th:if="${assignmentMap[project.id] == null || assignmentMap[project.id].isEmpty()}">
                    <td colspan="5" class="empty">Chưa có phân công</td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>

    <div class="modal-backdrop"
         id="projectModal"
         data-modal
         th:data-open="${showProjectModal} ? 'true' : 'false'"
         th:data-mode="${projectModalMode}"
         th:data-record-id="${projectEditId}"
         th:data-create-url="@{/cms/projects}"
         data-create-title="Thêm dự án"
         data-edit-title="Cập nhật dự án"
         data-create-text="Lưu"
         data-edit-text="Cập nhật">
        <div class="modal">
            <div class="modal-header">
                <h2 data-modal-title>Quản lý Dự án</h2>
                <button type="button" class="icon-button" data-close-modal>&times;</button>
            </div>
            <form id="projectForm" th:action="@{/cms/projects}" th:object="${projectForm}" method="post">
                <div class="modal-body grid two-columns">
                    <div class="field">
                        <label for="projectCode">Ma Dự án</label>
                        <input id="projectCode" th:field="*{code}" data-field="code" type="text" placeholder="PRJ-001">
                        <small th:if="${#fields.hasErrors('code')}" th:errors="*{code}" class="error-text">Lỗi</small>
                    </div>
                    <div class="field">
                        <label for="projectName">Ten Dự án</label>
                        <input id="projectName" th:field="*{name}" data-field="name" type="text" placeholder="Dự án A">
                        <small th:if="${#fields.hasErrors('name')}" th:errors="*{name}" class="error-text">Lỗi</small>
                    </div>
                    <div class="field">
                        <label for="projectDescription">Mô tả</label>
                        <textarea id="projectDescription" th:field="*{description}" data-field="description" rows="3"></textarea>
                    </div>
                    <div class="field">
                        <label for="projectStart">Ngày bắt đầu</label>
                        <input id="projectStart" th:field="*{startDate}" data-field="startDate" type="date">
                        <small th:if="${#fields.hasErrors('startDate')}" th:errors="*{startDate}" class="error-text">Lỗi</small>
                    </div>
                    <div class="field">
                        <label for="projectEnd">Ngày kết thúc</label>
                        <input id="projectEnd" th:field="*{endDate}" data-field="endDate" type="date">
                    </div>
                    <div class="field">
                        <label for="projectStatus">Trạng thái</label>
                        <select id="projectStatus" th:field="*{status}" data-field="status">
                            <option value="">-- Chọn trạng thái --</option>
                            <option th:each="status : ${projectStatuses}"
                                    th:value="${status}"
                                    th:text="${status}">Status</option>
                        </select>
                    </div>
                    <div class="field">
                        <label for="projectManager">Quản lý</label>
                        <select id="projectManager" th:field="*{managerId}" data-field="managerId">
                            <option value="">-- Không có --</option>
                            <option th:each="employee : ${employees}"
                                    th:value="${employee.id}"
                                    th:text="${employee.fullName}">Nhân viên</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="button secondary" data-close-modal>Hủy</button>
                    <button type="submit" class="button" data-modal-submit>Lưu</button>
                </div>
            </form>
        </div>
    </div>

    <div class="modal-backdrop"
         id="assignmentModal"
         data-modal
         th:data-open="${showAssignmentModal} ? 'true' : 'false'"
         data-mode="create"
         th:data-create-url="@{/cms/projects/assign}"
         data-create-title="Gán nhân sự"
         data-create-text="Gán">
        <div class="modal">
            <div class="modal-header">
                <h2 data-modal-title>Gán nhân sự</h2>
                <button type="button" class="icon-button" data-close-modal>&times;</button>
            </div>
            <form id="assignmentForm" th:action="@{/cms/projects/assign}" th:object="${assignmentForm}" method="post">
                <div class="modal-body grid two-columns">
                    <div class="field">
                        <label for="assignmentProject">Dự án</label>
                        <select id="assignmentProject" th:field="*{projectId}" data-field="projectId">
                            <option value="">-- Chọn dự án --</option>
                            <option th:each="project : ${projects}"
                                    th:value="${project.id}"
                                    th:text="${project.name}">Dự án</option>
                        </select>
                        <small th:if="${#fields.hasErrors('projectId')}" th:errors="*{projectId}" class="error-text">Lỗi</small>
                    </div>
                    <div class="field">
                        <label for="assignmentEmployee">Nhân viên</label>
                        <select id="assignmentEmployee" th:field="*{employeeId}" data-field="employeeId">
                            <option value="">-- Chọn nhân viên --</option>
                            <option th:each="employee : ${employees}"
                                    th:value="${employee.id}"
                                    th:text="${employee.fullName}">Nhân viên</option>
                        </select>
                        <small th:if="${#fields.hasErrors('employeeId')}" th:errors="*{employeeId}" class="error-text">Lỗi</small>
                    </div>
                    <div class="field">
                        <label for="assignmentRole">Vai trò</label>
                        <input id="assignmentRole" th:field="*{roleName}" data-field="roleName" type="text" placeholder="Developer">
                    </div>
                    <div class="field">
                        <label for="assignmentAllocation">Tỷ lệ (%)</label>
                        <input id="assignmentAllocation" th:field="*{allocationPercent}" data-field="allocationPercent" type="number" step="1">
                    </div>
                    <div class="field">
                        <label for="assignmentStart">Ngày bắt đầu</label>
                        <input id="assignmentStart" th:field="*{startDate}" data-field="startDate" type="date">
                        <small th:if="${#fields.hasErrors('startDate')}" th:errors="*{startDate}" class="error-text">Lỗi</small>
                    </div>
                    <div class="field">
                        <label for="assignmentEnd">Ngày kết thúc</label>
                        <input id="assignmentEnd" th:field="*{endDate}" data-field="endDate" type="date">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="button secondary" data-close-modal>Hủy</button>
                    <button type="submit" class="button" data-modal-submit>Gán</button>
                </div>
            </form>
        </div>
    </div>
</section>
</html>




