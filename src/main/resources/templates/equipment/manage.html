<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" th:replace="~{layout :: layout(~{::section})}">
<section th:fragment="content">
    <div class="card">
        <div class="table-actions">
            <div>
                <button type="button" class="button" data-open-modal="equipmentModal" data-mode="create">
                    ‚ûï Th√™m thi·∫øt b·ªã m·ªõi
                </button>
            </div>
            <div class="table-summary" th:if="${equipment != null and !equipment.isEmpty()}">
                T·ªïng c·ªông: <strong th:text="${equipment.size()}">0</strong> thi·∫øt b·ªã
            </div>
        </div>
        
        <!-- Filter form -->
        <form th:action="@{/cms/equipment}" method="get" class="filter-card">
            <div class="filter-grid">
                <div class="field">
                    <label for="filter-name">üîç T√¨m theo t√™n</label>
                    <input id="filter-name" type="text" name="name" placeholder="Nh·∫≠p t√™n thi·∫øt b·ªã" th:value="${param.name}">
                </div>
                <div class="field">
                    <label for="filter-status">üìä Tr·∫°ng th√°i</label>
                    <select id="filter-status" name="status">
                        <option value="">T·∫•t c·∫£ tr·∫°ng th√°i</option>
                        <option th:each="status : ${equipmentStatuses}" 
                                th:value="${status.name()}" 
                                th:selected="${param.status != null and param.status.toString() == status.name()}"
                                th:text="${status.displayName}"></option>
                    </select>
                </div>
                <div class="field">
                    <label for="filter-type">üè∑Ô∏è Lo·∫°i thi·∫øt b·ªã</label>
                    <input id="filter-type" type="text" name="type" placeholder="Nh·∫≠p lo·∫°i thi·∫øt b·ªã" th:value="${param.type}">
                </div>
                <div class="filter-actions">
                    <button type="submit" class="button">üîç L·ªçc</button>
                    <a th:href="@{/cms/equipment}" class="button secondary">üîÑ X√≥a</a>
                </div>
            </div>
        </form>
        
        <div class="table-wrapper">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>M√£</th>
                        <th>T√™n</th>
                        <th>Lo·∫°i</th>
                        <th>S·ªë serial</th>
                        <th>Tr·∫°ng th√°i</th>
                        <th>Ng√†y mua</th>
                        <th>Gi√° mua</th>
                        <th>Ph√¢n b·ªï cho</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    <tr th:each="item : ${equipment}">
                        <td th:text="${item.code ?: '-'}"></td>
                        <td th:text="${item.name ?: '-'}"></td>
                        <td th:text="${item.type ?: '-'}"></td>
                        <td th:text="${item.serialNumber ?: '-'}"></td>
                        <td>
                            <span class="status-badge" 
                                  th:classappend="${item.status != null ? 'status-' + item.status.name().toLowerCase() : ''}"
                                  th:text="${item.status != null ? item.status.displayName : '-'}"></span>
                        </td>
                        <td th:text="${item.purchaseDate != null ? #temporals.format(item.purchaseDate, 'dd/MM/yyyy') : '-'}"></td>
                        <td th:text="${item.purchasePrice != null ? #numbers.formatDecimal(item.purchasePrice, 0, 'COMMA', 2, 'POINT') : '-'}"></td>
                        <td th:text="${item.assignedToEmployeeName ?: 'Ch∆∞a ph√¢n b·ªï'}"></td>
                        <td class="actions-cell">
                            <div class="action-buttons">
                                <button type="button" class="action-btn action-edit" data-open-modal="equipmentModal" data-mode="edit"
                                        th:attr="data-record-id=${item.id},
                                                 data-update-url=@{/cms/equipment/{id}/update(id=${item.id})},
                                                 data-value-code=${item.code != null ? item.code : ''},
                                                 data-value-name=${item.name != null ? item.name : ''},
                                                 data-value-type=${item.type != null ? item.type : ''},
                                                 data-value-serial-number=${item.serialNumber != null ? item.serialNumber : ''},
                                                 data-value-status=${item.status != null ? item.status.name() : ''},
                                                 data-value-purchase-date=${item.purchaseDate != null ? #temporals.format(item.purchaseDate, 'yyyy-MM-dd') : ''},
                                                 data-value-purchase-price=${item.purchasePrice != null ? item.purchasePrice.toString() : ''}">
                                    ‚úèÔ∏è S·ª≠a
                                </button>
                                
                                <!-- Assign/Unassign buttons -->
                                <form th:if="${item.status != null and item.status.name() == 'AVAILABLE'}" 
                                      th:action="@{/cms/equipment/{id}/assign(id=${item.id})}" 
                                      method="post" 
                                      class="assign-form">
                                    <select name="employeeId" required class="employee-select">
                                        <option value="">-- Ch·ªçn nh√¢n vi√™n --</option>
                                        <option th:each="emp : ${employees}" 
                                                th:value="${emp.id}" 
                                                th:text="${emp.fullName}"></option>
                                    </select>
                                    <button type="submit" class="action-btn action-assign">üì¶ Ph√¢n b·ªï</button>
                                </form>
                                
                                <form th:if="${item.status != null and item.status.name() == 'ASSIGNED'}" 
                                      th:action="@{/cms/equipment/{id}/unassign(id=${item.id})}" 
                                      method="post" 
                                      class="inline-form">
                                    <button type="submit" class="action-btn action-unassign">‚Ü©Ô∏è H·ªßy</button>
                                </form>
                                
                                <form th:action="@{/cms/equipment/{id}/delete(id=${item.id})}" method="post"
                                      th:attr="data-confirm-message=${'B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a ' + (item.name != null ? item.name : 'thi·∫øt b·ªã n√†y') + '?'}"
                                      class="inline-form">
                                    <button type="submit" class="action-btn action-delete">üóëÔ∏è X√≥a</button>
                                </form>
                            </div>
                        </td>
                    </tr>
                    <tr th:if="${equipment == null or equipment.isEmpty()}">
                        <td colspan="9" class="empty">
                            <div>Ch∆∞a c√≥ thi·∫øt b·ªã n√†o</div>
                            <div style="margin-top: 16px;">
                                <button type="button" class="button" data-open-modal="equipmentModal" data-mode="create">
                                    ‚ûï Th√™m thi·∫øt b·ªã ƒë·∫ßu ti√™n
                                </button>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <div class="modal-backdrop"
         id="equipmentModal"
         data-modal
         th:data-open="${showModal} ? 'true' : 'false'"
         th:data-mode="${modalMode}"
         th:data-record-id="${editId}"
         th:data-create-url="@{/cms/equipment}"
         data-create-title="Th√™m thi·∫øt b·ªã"
         data-edit-title="C·∫≠p nh·∫≠t thi·∫øt b·ªã"
         data-create-text="L∆∞u"
         data-edit-text="C·∫≠p nh·∫≠t">
        <div class="modal">
            <div class="modal-header">
                <h2 data-modal-title>Qu·∫£n l√Ω thi·∫øt b·ªã</h2>
                <button type="button" class="icon-button" data-close-modal>&times;</button>
            </div>
            <form id="equipmentForm" th:action="@{/cms/equipment}" th:object="${equipmentForm}" method="post">
                <div class="modal-body grid two-columns">
                    <div class="field">
                        <label for="code">M√£ thi·∫øt b·ªã</label>
                        <input id="code" th:field="*{code}" data-field="code" type="text" placeholder="EQ-001">
                        <small th:if="${#fields.hasErrors('code')}" th:errors="*{code}" class="error-text">L·ªói</small>
                    </div>
                    <div class="field">
                        <label for="name">T√™n thi·∫øt b·ªã</label>
                        <input id="name" th:field="*{name}" data-field="name" type="text" placeholder="Laptop Dell">
                        <small th:if="${#fields.hasErrors('name')}" th:errors="*{name}" class="error-text">L·ªói</small>
                    </div>
                    <div class="field">
                        <label for="type">Lo·∫°i thi·∫øt b·ªã</label>
                        <input id="type" th:field="*{type}" data-field="type" type="text" placeholder="Laptop">
                    </div>
                    <div class="field">
                        <label for="serialNumber">S·ªë serial</label>
                        <input id="serialNumber" th:field="*{serialNumber}" data-field="serialNumber" type="text" placeholder="ABC123456">
                    </div>
                    <div class="field">
                        <label for="status">Tr·∫°ng th√°i</label>
                        <select id="status" th:field="*{status}" data-field="status">
                            <option value="">-- Ch·ªçn tr·∫°ng th√°i --</option>
                            <option th:each="status : ${equipmentStatuses}" 
                                    th:value="${status.name()}" 
                                    th:text="${status.displayName}"></option>
                        </select>
                        <small th:if="${#fields.hasErrors('status')}" th:errors="*{status}" class="error-text">L·ªói</small>
                    </div>
                    <div class="field">
                        <label for="purchaseDate">Ng√†y mua</label>
                        <input id="purchaseDate" th:field="*{purchaseDate}" data-field="purchaseDate" type="date">
                    </div>
                    <div class="field">
                        <label for="purchasePrice">Gi√° mua</label>
                        <input id="purchasePrice" th:field="*{purchasePrice}" data-field="purchasePrice" type="number" step="0.01" placeholder="15000000">
                    </div>
                    <div class="field">
                        <label for="notes">Ghi ch√∫</label>
                        <textarea id="notes" th:field="*{notes}" data-field="notes" placeholder="Ghi ch√∫ v·ªÅ thi·∫øt b·ªã"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="button secondary" data-close-modal>H·ªßy</button>
                    <button type="submit" class="button" data-modal-submit>L∆∞u</button>
                </div>
            </form>
        </div>
    </div>
</section>
</html>
