<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" th:replace="~{layout :: layout(~{::section})}">
<section th:fragment="content">
    <div class="card">
        <div class="table-actions">
            <div>
                <button type="button" class="button" data-open-modal="equipmentModal" data-mode="create">
                    + Thêm thiết bị
                </button>
            </div>
        </div>
        
        <!-- Filter form -->
        <form th:action="@{/cms/equipment}" method="get" class="filters">
            <input type="text" name="name" placeholder="Tìm theo tên" th:value="${param.name}">
            <select name="status">
                <option value="">Tất cả trạng thái</option>
                <option th:each="status : ${equipmentStatuses}" 
                        th:value="${status}" 
                        th:selected="${param.status == status}"
                        th:text="${status.displayName}"></option>
            </select>
            <input type="text" name="type" placeholder="Tìm theo loại" th:value="${param.type}">
            <button type="submit" class="button secondary">Lọc</button>
        </form>
        
        <div class="table-wrapper">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Mã</th>
                        <th>Tên</th>
                        <th>Loại</th>
                        <th>Số serial</th>
                        <th>Trạng thái</th>
                        <th>Ngày mua</th>
                        <th>Giá mua</th>
                        <th>Phân bổ cho</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    <tr th:each="item : ${equipment}">
                        <td th:text="${item.code}"></td>
                        <td th:text="${item.name}"></td>
                        <td th:text="${item.type}"></td>
                        <td th:text="${item.serialNumber}"></td>
                        <td th:text="${item.status.displayName}"></td>
                        <td th:text="${#temporals.format(item.purchaseDate, 'dd/MM/yyyy')}"></td>
                        <td th:text="${#numbers.formatDecimal(item.purchasePrice, 0, 'COMMA', 2, 'POINT')}"></td>
                        <td th:text="${item.assignedToEmployeeName ?: 'Chưa phân bổ'}"></td>
                        <td class="actions-cell">
                            <button type="button" class="button-link" data-open-modal="equipmentModal" data-mode="edit"
                                    th:attr="data-record-id=${item.id},
                                             data-update-url=@{/cms/equipment/{id}/update(id=${item.id})},
                                             data-value-code=${item.code},
                                             data-value-name=${item.name},
                                             data-value-type=${item.type},
                                             data-value-serial-number=${item.serialNumber},
                                             data-value-status=${item.status},
                                             data-value-purchase-date=${item.purchaseDate},
                                             data-value-purchase-price=${item.purchasePrice},
                                             data-value-notes=${item.notes}">
                                Chỉnh sửa
                            </button>
                            
                            <!-- Assign/Unassign buttons -->
                            <form th:if="${item.status.name() == 'AVAILABLE'}" 
                                  th:action="@{/cms/equipment/{id}/assign(id=${item.id})}" 
                                  method="post" 
                                  style="display: inline;">
                                <select name="employeeId" required style="margin-right: 8px;">
                                    <option value="">-- Chọn nhân viên --</option>
                                    <option th:each="emp : ${employees}" 
                                            th:value="${emp.id}" 
                                            th:text="${emp.fullName}"></option>
                                </select>
                                <button type="submit" class="button-link">Phân bổ</button>
                            </form>
                            
                            <form th:if="${item.status.name() == 'ASSIGNED'}" 
                                  th:action="@{/cms/equipment/{id}/unassign(id=${item.id})}" 
                                  method="post" 
                                  style="display: inline;">
                                <button type="submit" class="button-link">Hủy phân bổ</button>
                            </form>
                            
                            <form th:action="@{/cms/equipment/{id}/delete(id=${item.id})}" method="post"
                                  th:attr="data-confirm-message=${'Bạn có chắc muốn xóa ' + item.name + '?'}">
                                <button type="submit" class="link danger">Xóa</button>
                            </form>
                        </td>
                    </tr>
                    <tr th:if="${equipment.isEmpty()}">
                        <td colspan="9" class="empty">Chưa có thiết bị nào</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <div class="modal-backdrop"
         id="equipmentModal"
         data-modal
         th:data-open="${showModal} ? 'true' : 'false'"
         th:data-mode="${modalMode}"
         th:data-record-id="${editId}"
         th:data-create-url="@{/cms/equipment}"
         data-create-title="Thêm thiết bị"
         data-edit-title="Cập nhật thiết bị"
         data-create-text="Lưu"
         data-edit-text="Cập nhật">
        <div class="modal">
            <div class="modal-header">
                <h2 data-modal-title>Quản lý thiết bị</h2>
                <button type="button" class="icon-button" data-close-modal>&times;</button>
            </div>
            <form id="equipmentForm" th:action="@{/cms/equipment}" th:object="${equipmentForm}" method="post">
                <div class="modal-body grid two-columns">
                    <div class="field">
                        <label for="code">Mã thiết bị</label>
                        <input id="code" th:field="*{code}" data-field="code" type="text" placeholder="EQ-001">
                        <small th:if="${#fields.hasErrors('code')}" th:errors="*{code}" class="error-text">Lỗi</small>
                    </div>
                    <div class="field">
                        <label for="name">Tên thiết bị</label>
                        <input id="name" th:field="*{name}" data-field="name" type="text" placeholder="Laptop Dell">
                        <small th:if="${#fields.hasErrors('name')}" th:errors="*{name}" class="error-text">Lỗi</small>
                    </div>
                    <div class="field">
                        <label for="type">Loại thiết bị</label>
                        <input id="type" th:field="*{type}" data-field="type" type="text" placeholder="Laptop">
                    </div>
                    <div class="field">
                        <label for="serialNumber">Số serial</label>
                        <input id="serialNumber" th:field="*{serialNumber}" data-field="serialNumber" type="text" placeholder="ABC123456">
                    </div>
                    <div class="field">
                        <label for="status">Trạng thái</label>
                        <select id="status" th:field="*{status}" data-field="status">
                            <option value="">-- Chọn trạng thái --</option>
                            <option th:each="status : ${equipmentStatuses}" 
                                    th:value="${status}" 
                                    th:text="${status.displayName}"></option>
                        </select>
                        <small th:if="${#fields.hasErrors('status')}" th:errors="*{status}" class="error-text">Lỗi</small>
                    </div>
                    <div class="field">
                        <label for="purchaseDate">Ngày mua</label>
                        <input id="purchaseDate" th:field="*{purchaseDate}" data-field="purchaseDate" type="date">
                    </div>
                    <div class="field">
                        <label for="purchasePrice">Giá mua</label>
                        <input id="purchasePrice" th:field="*{purchasePrice}" data-field="purchasePrice" type="number" step="0.01" placeholder="15000000">
                    </div>
                    <div class="field">
                        <label for="notes">Ghi chú</label>
                        <textarea id="notes" th:field="*{notes}" data-field="notes" placeholder="Ghi chú về thiết bị"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="button secondary" data-close-modal>Hủy</button>
                    <button type="submit" class="button" data-modal-submit>Lưu</button>
                </div>
            </form>
        </div>
    </div>
</section>
</html>
