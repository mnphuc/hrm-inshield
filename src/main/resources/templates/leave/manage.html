<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" th:replace="~{layout :: layout(~{::section})}">
<section th:fragment="content">
    <div class="card pending-leaves-card">
        <div class="card-header">
            <h2>⏳ Đơn chờ duyệt</h2>
            <div class="header-actions">
                <span class="badge-count" th:if="${pendingRequests != null and !pendingRequests.isEmpty()}" 
                      th:text="${pendingRequests.size()} + ' đơn'">0 đơn</span>
                <button type="button" class="button" data-open-modal="leaveModal" data-mode="create">
                    ➕ Tạo đơn nghỉ phép mới
                </button>
            </div>
        </div>
        <div class="table-wrapper">
            <table class="data-table">
                <thead>
                <tr>
                    <th>👤 Nhân viên</th>
                    <th>🏷️ Loại</th>
                    <th>📅 Thời gian</th>
                    <th>📊 Trạng thái</th>
                    <th>⚙️ Thao tác</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="leave : ${pendingRequests}">
                    <td class="employee-name" th:text="${employeeNames[leave.employeeId]} ?: '—'">Nhân viên</td>
                    <td>
                        <span class="leave-type-badge" th:text="${leave.type}">ANNUAL</span>
                    </td>
                    <td class="date-range">
                        <span th:text="${#temporals.format(leave.startDate, 'dd/MM/yyyy')}">01/01/2024</span>
                        <span class="date-separator">→</span>
                        <span th:text="${#temporals.format(leave.endDate, 'dd/MM/yyyy')}">05/01/2024</span>
                        <span class="days-count" th:text="'(' + ${leave.totalDays} + ' ngày)'">(5 ngày)</span>
                    </td>
                    <td>
                        <span class="status-badge leave-status-pending" th:text="${leave.status}">PENDING</span>
                    </td>
                    <td class="actions-cell">
                        <form th:action="@{/cms/leave/{id}/decision(id=${leave.id})}" method="post" th:object="${decisionForm}" class="decision-form">
                            <div class="decision-controls">
                                <select th:field="*{status}" th:id="'leave-status-' + ${leave.id}" class="status-select">
                                    <option th:each="status : ${leaveStatuses}"
                                            th:value="${status}"
                                            th:selected="${status} == ${leave.status}"
                                            th:text="${status}">STATUS</option>
                                </select>
                                <select th:field="*{approverId}" th:id="'leave-approver-' + ${leave.id}" class="approver-select">
                                    <option value="">-- Người duyệt --</option>
                                    <option th:each="employee : ${employees}"
                                            th:value="${employee.id}"
                                            th:text="${employee.fullName}">Người duyệt</option>
                                </select>
                                <button type="submit" class="action-btn action-update">✅ Cập nhật</button>
                            </div>
                        </form>
                        <form th:action="@{/cms/leave/{id}/delete(id=${leave.id})}" method="post" class="inline-form">
                            <button type="submit" class="action-btn action-delete" 
                                    th:attr="onclick='return confirm(\'Bạn có chắc muốn xóa đơn nghỉ phép này?\')'">🗑️ Xóa</button>
                        </form>
                    </td>
                </tr>
                <tr th:if="${pendingRequests == null or pendingRequests.isEmpty()}">
                    <td colspan="5" class="empty">Chưa có đơn chờ duyệt</td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>

    <div class="card all-leaves-card">
        <div class="card-header">
            <h2>📋 Tất cả đơn nghỉ phép</h2>
            <span class="badge-count" th:if="${leaveRequests != null and !leaveRequests.isEmpty()}" 
                  th:text="${leaveRequests.size()} + ' đơn'">0 đơn</span>
        </div>
        <div class="table-wrapper">
            <table class="data-table">
                <thead>
                <tr>
                    <th>👤 Nhân viên</th>
                    <th>🏷️ Loại</th>
                    <th>📅 Thời gian</th>
                    <th>📊 Trạng thái</th>
                    <th>✅ Người duyệt</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="leave : ${leaveRequests}">
                    <td class="employee-name" th:text="${employeeNames[leave.employeeId]} ?: '—'">Nhân viên</td>
                    <td>
                        <span class="leave-type-badge" th:text="${leave.type}">ANNUAL</span>
                    </td>
                    <td class="date-range">
                        <span th:text="${#temporals.format(leave.startDate, 'dd/MM/yyyy')}">01/01/2024</span>
                        <span class="date-separator">→</span>
                        <span th:text="${#temporals.format(leave.endDate, 'dd/MM/yyyy')}">05/01/2024</span>
                        <span class="days-count" th:text="'(' + ${leave.totalDays} + ' ngày)'">(5 ngày)</span>
                    </td>
                    <td>
                        <span class="status-badge" 
                              th:classappend="${leave.status != null ? 'leave-status-' + leave.status.name().toLowerCase() : ''}"
                              th:text="${leave.status}">APPROVED</span>
                    </td>
                    <td class="approver-name" th:text="${leave.approverId != null ? employeeNames[leave.approverId] : '—'}">—</td>
                </tr>
                <tr th:if="${leaveRequests == null or leaveRequests.isEmpty()}">
                    <td colspan="5" class="empty">Chưa có đơn nghỉ phép</td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Modal for creating/editing leave request -->
    <div class="modal-backdrop"
         id="leaveModal"
         data-modal
         th:data-open="${showModal} ? 'true' : 'false'"
         th:data-mode="${modalMode}"
         th:data-record-id="${editId}"
         th:data-create-url="@{/cms/leave}"
         data-create-title="Tạo đơn nghỉ phép mới"
         data-edit-title="Cập nhật đơn nghỉ phép"
         data-create-text="Gửi đơn"
         data-edit-text="Cập nhật">
        <div class="modal">
            <div class="modal-header">
                <h2 data-modal-title>Tạo đơn nghỉ phép mới</h2>
                <button type="button" class="icon-button" data-close-modal>&times;</button>
            </div>
            <form id="leaveForm" th:action="@{/cms/leave}" th:object="${leaveForm}" method="post" class="leave-request-form">
                <div class="modal-body">
                    <div class="form-grid">
                        <div class="field">
                            <label for="leaveEmployee">👤 Nhân viên</label>
                            <select id="leaveEmployee" th:field="*{employeeId}" data-field="employeeId">
                                <option value="">-- Chọn nhân viên --</option>
                                <option th:each="employee : ${employees}"
                                        th:value="${employee.id}"
                                        th:text="${employee.fullName}">Nhân viên</option>
                            </select>
                            <small th:if="${#fields.hasErrors('employeeId')}" th:errors="*{employeeId}" class="error-text">Lỗi</small>
                        </div>
                        <div class="field">
                            <label for="leaveType">🏷️ Loại nghỉ</label>
                            <select id="leaveType" th:field="*{type}" data-field="type">
                                <option value="">-- Chọn loại --</option>
                                <option th:each="type : ${leaveTypes}"
                                        th:value="${type}"
                                        th:text="${type}">TYPE</option>
                            </select>
                            <small th:if="${#fields.hasErrors('type')}" th:errors="*{type}" class="error-text">Lỗi</small>
                        </div>
                        <div class="field">
                            <label for="leaveStart">📅 Ngày bắt đầu</label>
                            <input id="leaveStart" th:field="*{startDate}" type="date" data-field="startDate">
                            <small th:if="${#fields.hasErrors('startDate')}" th:errors="*{startDate}" class="error-text">Lỗi</small>
                        </div>
                        <div class="field">
                            <label for="leaveEnd">📅 Ngày kết thúc</label>
                            <input id="leaveEnd" th:field="*{endDate}" type="date" data-field="endDate">
                            <small th:if="${#fields.hasErrors('endDate')}" th:errors="*{endDate}" class="error-text">Lỗi</small>
                        </div>
                        <div class="field">
                            <label for="totalDays">📊 Tổng số ngày</label>
                            <input id="totalDays" th:field="*{totalDays}" type="number" step="0.5" placeholder="0.0" data-field="totalDays">
                            <small th:if="${#fields.hasErrors('totalDays')}" th:errors="*{totalDays}" class="error-text">Lỗi</small>
                        </div>
                        <div class="field full-width">
                            <label for="reason">📝 Lý do</label>
                            <textarea id="reason" th:field="*{reason}" rows="4" placeholder="Nhập lý do nghỉ phép..." data-field="reason"></textarea>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="button secondary" data-close-modal>Hủy</button>
                    <button type="submit" class="button" data-modal-submit>✅ Gửi đơn nghỉ phép</button>
                </div>
            </form>
        </div>
    </div>
</section>
</html>


