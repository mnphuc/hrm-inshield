<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" th:replace="~{layout :: layout(~{::section})}">
<section th:fragment="content">
    <div class="card">
        <div class="table-actions">
            <div>
                <button type="button" class="button" data-open-modal="attendanceModal" data-mode="create">
                    + Thêm chấm công
                </button>
            </div>
            <div class="pagination" th:if="${totalPages > 1}">
                <a class="page-link"
                   th:classappend="${currentPage == 0}? 'disabled'"
                   th:href="${currentPage == 0}? '#': @{/cms/attendance(page=${currentPage - 1}, size=${pageSize})}">Trang trước</a>
                <a class="page-link"
                   th:each="pageNum : ${#numbers.sequence(0, totalPages - 1)}"
                   th:text="${pageNum + 1}"
                   th:href="@{/cms/attendance(page=${pageNum}, size=${pageSize})}"
                   th:classappend="${pageNum == currentPage}? 'active'">1</a>
                <a class="page-link"
                   th:classappend="${currentPage + 1 >= totalPages}? 'disabled'"
                   th:href="${currentPage + 1 >= totalPages}? '#': @{/cms/attendance(page=${currentPage + 1}, size=${pageSize})}">Trang sau</a>
            </div>
        </div>
        <div class="table-wrapper">
            <table class="data-table">
                <thead>
                <tr>
                    <th>Nhân viên</th>
                    <th>Ngày</th>
                    <th>Vào</th>
                    <th>Ra</th>
                    <th>Số giờ</th>
                    <th>Ghi chú</th>
                    <th></th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="record : ${records}">
                    <td th:text="${employeeNameMap[record.employeeId]}">Nhân viên</td>
                    <td th:text="${record.workDate}">2024-01-01</td>
                    <td th:text="${record.checkIn}">08:00</td>
                    <td th:text="${record.checkOut}">17:00</td>
                    <td th:text="${record.workedHours}">8</td>
                    <td th:text="${record.notes}">Ghi chú</td>
                    <td class="actions-cell">
                        <button type="button" class="button-link" data-open-modal="attendanceModal" data-mode="edit"
                                th:attr="data-record-id=${record.id},
                                         data-update-url=@{/cms/attendance/{id}/update(id=${record.id})},
                                         data-value-employee-id=${record.employeeId},
                                         data-value-work-date=${record.workDate},
                                         data-value-check-in=${record.checkIn},
                                         data-value-check-out=${record.checkOut},
                                         data-value-worked-hours=${record.workedHours},
                                         data-value-notes=${record.notes}">
                            Chỉnh sửa
                        </button>
                        <form th:action="@{/cms/attendance/{id}/delete(id=${record.id})}" method="post"
                              th:attr="data-confirm-message=${'Bạn có chắc muốn xóa chấm công ngày ' + record.workDate + '?'}">
                            <button type="submit" class="link danger">Xóa</button>
                        </form>
                    </td>
                </tr>
                <tr th:if="${records.isEmpty()}">
                    <td colspan="7" class="empty">Chưa có dữ liệu chấm công</td>
                </tr>
                </tbody>
            </table>
        </div>
        <div class="table-summary" th:if="${totalElements > 0}">
            <p th:text="'Đang hiển thị ' + ${startRecord} + ' - ' + ${endRecord} + ' / ' + ${totalElements} + ' bản ghi'"></p>
        </div>
    </div>

    <div class="modal-backdrop"
         id="attendanceModal"
         data-modal
         th:data-open="${showModal} ? 'true' : 'false'"
         th:data-mode="${modalMode}"
         th:data-record-id="${editId}"
         th:data-create-url="@{/cms/attendance}"
         data-create-title="Thêm chấm công"
         data-edit-title="Cập nhật chấm công"
         data-create-text="Lưu"
         data-edit-text="Cập nhật">
        <div class="modal">
            <div class="modal-header">
                <h2 data-modal-title>Quản lý chấm công</h2>
                <button type="button" class="icon-button" data-close-modal>&times;</button>
            </div>
            <form id="attendanceForm" th:action="@{/cms/attendance}" th:object="${attendanceForm}" method="post">
                <div class="modal-body grid two-columns">
                    <div class="field">
                        <label for="employeeId">Nhân viên</label>
                        <select id="employeeId" th:field="*{employeeId}" data-field="employeeId">
                            <option value="">-- Chọn nhân viên --</option>
                            <option th:each="employee : ${employees}"
                                    th:value="${employee.id}"
                                    th:text="${employee.fullName}">Nhân viên</option>
                        </select>
                        <small th:if="${#fields.hasErrors('employeeId')}" th:errors="*{employeeId}" class="error-text">Lỗi</small>
                    </div>
                    <div class="field">
                        <label for="workDate">Ngày làm</label>
                        <input id="workDate" th:field="*{workDate}" data-field="workDate" type="date">
                        <small th:if="${#fields.hasErrors('workDate')}" th:errors="*{workDate}" class="error-text">Lỗi</small>
                    </div>
                    <div class="field">
                        <label for="checkIn">Giờ vào</label>
                        <input id="checkIn" th:field="*{checkIn}" data-field="checkIn" type="time">
                    </div>
                    <div class="field">
                        <label for="checkOut">Giờ ra</label>
                        <input id="checkOut" th:field="*{checkOut}" data-field="checkOut" type="time">
                    </div>
                    <div class="field">
                        <label for="workedHours">Số giờ</label>
                        <input id="workedHours" th:field="*{workedHours}" data-field="workedHours" type="number" step="0.25" readonly>
                        <small class="help-text">Số giờ sẽ được tính tự động dựa trên giờ vào và giờ ra</small>
                    </div>
                    <div class="field">
                        <label for="notes">Ghi chú</label>
                        <textarea id="notes" th:field="*{notes}" data-field="notes" rows="2"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="button secondary" data-close-modal>Hủy</button>
                    <button type="submit" class="button" data-modal-submit>Lưu</button>
                </div>
            </form>
        </div>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const checkInInput = document.getElementById('checkIn');
            const checkOutInput = document.getElementById('checkOut');
            const workedHoursInput = document.getElementById('workedHours');
            const workDateInput = document.getElementById('workDate');
            
            function calculateWorkedHours() {
                if (checkInInput.value && checkOutInput.value) {
                    const checkInTime = new Date('2000-01-01T' + checkInInput.value + ':00');
                    const checkOutTime = new Date('2000-01-01T' + checkOutInput.value + ':00');
                    
                    if (checkOutTime > checkInTime) {
                        const diffMs = checkOutTime - checkInTime;
                        const diffHours = diffMs / (1000 * 60 * 60);
                        workedHoursInput.value = diffHours.toFixed(2);
                    } else {
                        workedHoursInput.value = '0';
                    }
                }
            }
            
            function setDefaultValues() {
                // Set today's date if not already set
                if (!workDateInput.value) {
                    const today = new Date();
                    const year = today.getFullYear();
                    const month = String(today.getMonth() + 1).padStart(2, '0');
                    const day = String(today.getDate()).padStart(2, '0');
                    workDateInput.value = `${year}-${month}-${day}`;
                }
                
                // Set default time if not already set
                if (!checkInInput.value) {
                    checkInInput.value = '08:00';
                }
                if (!checkOutInput.value) {
                    checkOutInput.value = '17:00';
                }
                
                // Calculate worked hours
                calculateWorkedHours();
            }
            
            checkInInput.addEventListener('change', calculateWorkedHours);
            checkOutInput.addEventListener('change', calculateWorkedHours);
            
            // Override the modal opening behavior for attendance modal
            const modal = document.getElementById('attendanceModal');
            if (modal) {
                // Listen for when modal is opened
                const observer = new MutationObserver(function(mutations) {
                    mutations.forEach(function(mutation) {
                        if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
                            if (modal.classList.contains('show')) {
                                // Check if it's create mode
                                const mode = modal.dataset.mode;
                                if (mode === 'create') {
                                    setTimeout(setDefaultValues, 50);
                                }
                            }
                        }
                    });
                });
                observer.observe(modal, { attributes: true });
                
                // Also listen for the open modal button clicks
                document.querySelectorAll('[data-open-modal="attendanceModal"]').forEach(button => {
                    button.addEventListener('click', function() {
                        const mode = this.dataset.mode;
                        if (mode === 'create') {
                            setTimeout(setDefaultValues, 100);
                        }
                    });
                });
            }
            
            // Set default values on page load
            setDefaultValues();
        });
    </script>
</section>
</html>



